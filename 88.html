<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小岛抢单工具</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #6c5ce7;
            --success-color: #00b894;
            --warning-color: #fdcb6e;
            --danger-color: #d63031;
            --info-color: #0984e3;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        
        .card {
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 12px 12px 0 0 !important;
            font-weight: 600;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-success {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            border-color: var(--warning-color);
            color: #333;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
        }
        
        .badge-success {
            background-color: var(--success-color);
        }
        
        .badge-warning {
            background-color: var(--warning-color);
            color: #333;
        }
        
        .badge-danger {
            background-color: var(--danger-color);
        }
        
        .badge-info {
            background-color: var(--info-color);
        }
        
        .log-container {
            height: 300px;
            overflow-y: auto;
            background-color: #2d3436;
            color: #dfe6e9;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', Courier, monospace;
        }
        
        .config-item {
            margin-bottom: 15px;
        }
        
        .keyword-badge {
            margin-right: 5px;
            margin-bottom: 5px;
            cursor: pointer;
        }
        
        .status-indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        
        .status-active {
            background-color: var(--success-color);
            animation: pulse 1.5s infinite;
        }
        
        .status-inactive {
            background-color: var(--danger-color);
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .nav-tabs .nav-link.active {
            font-weight: bold;
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
        }
        
        .order-card {
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }
        
        .order-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-lightning-charge"></i> 小岛抢单工具</h5>
                        <div>
                            <span class="status-indicator" id="statusIndicator"></span>
                            <span id="statusText">未启动</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="config-tab" data-bs-toggle="tab" data-bs-target="#config" type="button" role="tab">配置中心</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders" type="button" role="tab">订单列表</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button" role="tab">运行日志</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">抢单记录</button>
                            </li>
                        </ul>
                        
                        <div class="tab-content" id="mainTabsContent">
                            <!-- 配置中心 -->
                            <div class="tab-pane fade show active" id="config" role="tabpanel">
                                <form id="configForm">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h5><i class="bi bi-person-circle"></i> 用户信息</h5>
                                            <hr>
                                            
                                            <div class="mb-3">
                                                <label for="memberId" class="form-label">会员ID (memberId)</label>
                                                <input type="text" class="form-control" id="memberId" required>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="ids" class="form-label">IDS</label>
                                                <input type="text" class="form-control" id="ids" required>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="nickname" class="form-label">昵称</label>
                                                <input type="text" class="form-control" id="nickname" required>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="token" class="form-label">Token</label>
                                                <input type="text" class="form-control" id="token" required>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <h5><i class="bi bi-gear"></i> 抢单设置</h5>
                                            <hr>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">区域筛选</label>
                                                <div>
                                                    <div class="form-check form-check-inline">
                                                        <input class="form-check-input" type="radio" name="areaFilter" id="areaAll" value="all" checked>
                                                        <label class="form-check-label" for="areaAll">全部区域</label>
                                                    </div>
                                                    <div class="form-check form-check-inline">
                                                        <input class="form-check-input" type="radio" name="areaFilter" id="areaQ" value="q">
                                                        <label class="form-check-label" for="areaQ">Q区</label>
                                                    </div>
                                                    <div class="form-check form-check-inline">
                                                        <input class="form-check-input" type="radio" name="areaFilter" id="areaV" value="v">
                                                        <label class="form-check-label" for="areaV">V区</label>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="delay" class="form-label">抢单延迟 (毫秒)</label>
                                                <input type="number" class="form-control" id="delay" min="0" max="1000" value="300">
                                                <div class="form-text">建议值: 100-600ms</div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">关键词筛选</label>
                                                <div class="mb-2">
                                                    <div id="quickKeywords" class="d-flex flex-wrap">
                                                        <span class="badge bg-info keyword-badge" data-keyword="开荒单">1: 开荒单</span>
                                                        <span class="badge bg-info keyword-badge" data-keyword="护航加强单">2: 护航加强单</span>
                                                        <span class="badge bg-info keyword-badge" data-keyword="暑假快乐单">3: 暑假快乐单</span>
                                                        <span class="badge bg-info keyword-badge" data-keyword="实验基地专属">4: 实验基地专属</span>
                                                        <span class="badge bg-info keyword-badge" data-keyword="烽火荣都专属">5: 烽火荣都专属</span>
                                                        <span class="badge bg-info keyword-badge" data-keyword="至尊护航单">6: 至尊护航单</span>
                                                        <span class="badge bg-info keyword-badge" data-keyword="狙击俱乐部单">7: 狙击俱乐部单</span>
                                                        <span class="badge bg-info keyword-badge" data-keyword="大神护航单">8: 大神护航单</span>
                                                        <span class="badge bg-info keyword-badge" data-keyword="赌超级无资箱">9: 赌超级无资箱</span>
                                                        <span class="badge bg-info keyword-badge" data-keyword="保底BOSS单">a: 保底BOSS单</span>
                                                        <span class="badge bg-info keyword-badge" data-keyword="苏尔南钻石单">b: 苏尔南钻石单</span>
                                                        <span class="badge bg-info keyword-badge" data-keyword="鸡腿">c: 鸡腿</span>
                                                        <span class="badge bg-info keyword-badge" data-keyword="奶茶">d: 奶茶</span>
                                                        <span class="badge bg-info keyword-badge" data-keyword="给打手加汉堡">e: 给打手加汉堡</span>
                                                        <span class="badge bg-info keyword-badge" data-keyword="给打手加鸡腿">f: 给打手加鸡腿</span>
                                                    </div>
                                                </div>
                                                <input type="text" class="form-control" id="keywordsInput" placeholder="输入关键词或点击上方快捷选择">
                                                <div class="form-text">多个关键词用逗号分隔，留空则匹配所有订单</div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="refreshInterval" class="form-label">刷新间隔 (秒)</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="refreshMin" placeholder="最小" min="0.1" max="10" step="0.1" value="0.3">
                                                    <span class="input-group-text">~</span>
                                                    <input type="number" class="form-control" id="refreshMax" placeholder="最大" min="0.1" max="10" step="0.1" value="0.7">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="d-flex justify-content-between mt-4">
                                        <button type="button" class="btn btn-outline-secondary" id="loadConfigBtn">
                                            <i class="bi bi-folder-symlink"></i> 加载上次配置
                                        </button>
                                        <div>
                                            <button type="button" class="btn btn-warning me-2" id="saveConfigBtn">
                                                <i class="bi bi-save"></i> 保存配置
                                            </button>
                                            <button type="button" class="btn btn-success" id="startBtn">
                                                <i class="bi bi-play-circle"></i> 启动抢单
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            
                            <!-- 订单列表 -->
                            <div class="tab-pane fade" id="orders" role="tabpanel">
                                <div class="d-flex justify-content-between mb-3">
                                    <h5><i class="bi bi-list-ul"></i> 可用订单</h5>
                                    <button class="btn btn-sm btn-outline-primary" id="refreshOrdersBtn">
                                        <i class="bi bi-arrow-clockwise"></i> 刷新列表
                                    </button>
                                </div>
                                <div id="ordersContainer">
                                    <div class="alert alert-info">
                                        请先启动抢单程序以查看可用订单
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 运行日志 -->
                            <div class="tab-pane fade" id="logs" role="tabpanel">
                                <div class="d-flex justify-content-between mb-3">
                                    <h5><i class="bi bi-terminal"></i> 运行日志</h5>
                                    <div>
                                        <button class="btn btn-sm btn-outline-danger me-2" id="clearLogsBtn">
                                            <i class="bi bi-trash"></i> 清空日志
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" id="exportLogsBtn">
                                            <i class="bi bi-download"></i> 导出日志
                                        </button>
                                    </div>
                                </div>
                                <div class="log-container" id="logContainer">
                                    <div class="text-muted">=== 小岛抢单工具日志 ===</div>
                                    <div class="text-muted">等待程序启动...</div>
                                </div>
                            </div>
                            
                            <!-- 抢单记录 -->
                            <div class="tab-pane fade" id="history" role="tabpanel">
                                <div class="d-flex justify-content-between mb-3">
                                    <h5><i class="bi bi-clock-history"></i> 抢单记录</h5>
                                    <div>
                                        <button class="btn btn-sm btn-outline-danger me-2" id="clearHistoryBtn">
                                            <i class="bi bi-trash"></i> 清空记录
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" id="exportHistoryBtn">
                                            <i class="bi bi-download"></i> 导出记录
                                        </button>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead>
                                            <tr>
                                                <th>时间</th>
                                                <th>订单ID</th>
                                                <th>区域</th>
                                                <th>类型</th>
                                                <th>金额</th>
                                                <th>延迟</th>
                                            </tr>
                                        </thead>
                                        <tbody id="historyTableBody">
                                            <tr>
                                                <td colspan="6" class="text-center text-muted">暂无抢单记录</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 订单详情模态框 -->
    <div class="modal fade" id="orderDetailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">订单详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="orderDetailContent">
                    <!-- 内容将通过JS动态填充 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // 全局变量
        let isRunning = false;
        let grabbedTaskIds = new Set();
        let config = {
            memberId: '',
            ids: '',
            nickname: '',
            token: '',
            areaFilter: null,
            keywords: [],
            delayMs: 300,
            refreshMin: 0.3,
            refreshMax: 0.7
        };
        
        // DOM加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化UI
            updateStatusIndicator();
            loadLastConfig();
            
            // 绑定事件
            document.getElementById('startBtn').addEventListener('click', toggleGrabber);
            document.getElementById('saveConfigBtn').addEventListener('click', saveConfig);
            document.getElementById('loadConfigBtn').addEventListener('click', loadLastConfig);
            document.getElementById('refreshOrdersBtn').addEventListener('click', refreshOrders);
            document.getElementById('clearLogsBtn').addEventListener('click', clearLogs);
            document.getElementById('exportLogsBtn').addEventListener('click', exportLogs);
            document.getElementById('clearHistoryBtn').addEventListener('click', clearHistory);
            document.getElementById('exportHistoryBtn').addEventListener('click', exportHistory);
            
            // 关键词快捷选择
            document.querySelectorAll('.keyword-badge').forEach(badge => {
                badge.addEventListener('click', function() {
                    const keyword = this.getAttribute('data-keyword');
                    const keywordsInput = document.getElementById('keywordsInput');
                    const currentValue = keywordsInput.value.trim();
                    
                    if (currentValue === '') {
                        keywordsInput.value = keyword;
                    } else {
                        // 检查是否已包含该关键词
                        const keywords = currentValue.split(',').map(k => k.trim());
                        if (!keywords.includes(keyword)) {
                            keywordsInput.value = currentValue + ', ' + keyword;
                        }
                    }
                });
            });
        });
        
        // 更新状态指示器
        function updateStatusIndicator() {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            if (isRunning) {
                indicator.className = 'status-indicator status-active';
                statusText.textContent = '运行中';
            } else {
                indicator.className = 'status-indicator status-inactive';
                statusText.textContent = '已停止';
            }
        }
        
        // 切换抢单状态
        function toggleGrabber() {
            if (isRunning) {
                stopGrabber();
            } else {
                startGrabber();
            }
        }
        
        // 启动抢单
        function startGrabber() {
            // 验证配置
            if (!validateConfig()) {
                return;
            }
            
            // 保存当前配置
            saveConfigToMemory();
            
            isRunning = true;
            updateStatusIndicator();
            document.getElementById('startBtn').innerHTML = '<i class="bi bi-stop-circle"></i> 停止抢单';
            document.getElementById('startBtn').className = 'btn btn-danger';
            
            logMessage('=== 抢单程序已启动 ===', 'success');
            logMessage(`区域筛选: ${getAreaFilterText(config.areaFilter)}`);
            logMessage(`关键词: ${config.keywords.length > 0 ? config.keywords.join(', ') : '无 (全选)'}`);
            logMessage(`抢单延迟: ${config.delayMs}ms`);
            logMessage(`刷新间隔: ${config.refreshMin}-${config.refreshMax}秒`);
            
            // 切换到订单列表标签页
            const ordersTab = new bootstrap.Tab(document.getElementById('orders-tab'));
            ordersTab.show();
            
            // 开始循环
            grabLoop();
        }
        
        // 停止抢单
        function stopGrabber() {
            isRunning = false;
            updateStatusIndicator();
            document.getElementById('startBtn').innerHTML = '<i class="bi bi-play-circle"></i> 启动抢单';
            document.getElementById('startBtn').className = 'btn btn-success';
            
            logMessage('=== 抢单程序已停止 ===', 'warning');
        }
        
        // 抢单主循环
        async function grabLoop() {
            if (!isRunning) return;
            
            try {
                const refreshInterval = getRandomRefreshInterval();
                logMessage(`正在检查可用订单 (${refreshInterval}秒后刷新)...`, 'info');
                
                const orders = await getAvailableOrders();
                displayOrders(orders);
                
                if (orders.length > 0) {
                    for (const order of orders) {
                        if (!isRunning) break;
                        
                        const taskId = order.taskId;
                        if (!grabbedTaskIds.has(taskId)) {
                            logMessage(`发现新订单: ${order.taskName} (ID: ${taskId})`, 'info');
                            grabbedTaskIds.add(taskId);
                            
                            const success = await takeOrder(taskId);
                            if (success) {
                                // 抢单成功，添加到历史记录
                                addToHistory(order);
                                // 短暂暂停后再继续
                                await sleep(2000);
                            }
                        }
                    }
                } else {
                    logMessage('暂无符合条件的订单', 'info');
                }
                
                if (isRunning) {
                    logMessage(`本轮检查完成，${refreshInterval}秒后继续...`, 'info');
                    setTimeout(grabLoop, refreshInterval * 1000);
                }
            } catch (error) {
                logMessage(`主循环出错: ${error.message}，5秒后重试...`, 'danger');
                if (isRunning) {
                    setTimeout(grabLoop, 5000);
                }
            }
        }
        
        // 获取可用订单
        async function getAvailableOrders() {
            try {
                const response = await axios.get('https://paidan.xlt666.club/yxdl/api/order/list', {
                    params: {
                        pageSize: 10,
                        pageNum: 1,
                        categoryId: 0
                    },
                    headers: {
                        token: config.token
                    },
                    timeout: 5000
                });
                
                if (response.data.code !== 200) {
                    throw new Error(response.data.msg || 'API返回错误');
                }
                
                const allOrders = response.data.rows || [];
                return filterOrders(allOrders);
            } catch (error) {
                throw new Error(`获取订单失败: ${error.message}`);
            }
        }
        
        // 过滤订单
        function filterOrders(orders) {
            return orders.filter(order => {
                // 筛选状态
                if (order.state !== 1) return false;
                
                // 区域筛选
                const catName = (order.categoryName || '').toLowerCase();
                let areaMatch = true;
                if (config.areaFilter !== null) {
                    if (config.areaFilter === 'q') {
                        areaMatch = catName.includes('q区');
                    } else if (config.areaFilter === 'v') {
                        areaMatch = catName.includes('v区');
                    }
                }
                if (!areaMatch) return false;
                
                // 关键词筛选
                if (config.keywords.length > 0) {
                    const taskName = (order.taskName || '').toLowerCase();
                    const taskDesc = (order.description || '').toLowerCase();
                    
                    const keywordMatch = config.keywords.some(kw => {
                        const keyword = kw.toLowerCase();
                        return taskName.includes(keyword) || taskDesc.includes(keyword);
                    });
                    
                    if (!keywordMatch) return false;
                }
                
                return true;
            });
        }
        
        // 抢单
        async function takeOrder(taskId) {
            try {
                logMessage(`准备抢单: 等待 ${config.delayMs}ms 延迟...`, 'info');
                await sleep(config.delayMs);
                
                const response = await axios.post('https://paidan.xlt666.club/yxdl/api/order/takeOrder', {
                    taskId: taskId,
                    memberId: config.memberId,
                    ids: [config.ids],
                    nickname: config.nickname,
                    avatar: "https://xiaolatiao.oss-cn-beijing.aliyuncs.com/uploadImg-test/wYp4xWmXfR.jpg"
                }, {
                    headers: {
                        token: config.token,
                        'Content-Type': 'application/json'
                    },
                    timeout: 5000
                });
                
                if (response.data.code === 200) {
                    const orderDetail = await getOrderDetail(taskId);
                    logMessage(`抢单成功! 订单ID: ${taskId}`, 'success');
                    logMessage(`区域: ${orderDetail.area || '未知'}`, 'success');
                    logMessage(`类型: ${orderDetail.order_type || '未知'}`, 'success');
                    logMessage(`金额: ${orderDetail.amount || '未知'}`, 'success');
                    return true;
                } else {
                    logMessage(`抢单失败: ${response.data.msg || '未知错误'}`, 'danger');
                    return false;
                }
            } catch (error) {
                logMessage(`抢单出错: ${error.message}`, 'danger');
                return false;
            }
        }
        
        // 获取订单详情
        async function getOrderDetail(taskId) {
            try {
                const response = await axios.get('https://paidan.xlt666.club/yxdl/api/order/getInfo', {
                    params: { taskId: taskId },
                    headers: { token: config.token },
                    timeout: 5000
                });
                
                if (response.data.code === 200) {
                    const order = response.data.data || {};
                    return {
                        task_id: taskId,
                        area: order.categoryName || "未知区域",
                        order_type: order.taskName || "未知类型",
                        ddh: order.orderNo || "未知单号",
                        tmd: order.receivePrice || "未知发单金额",
                        amount: order.outPrice || "未知到手金额",
                        send_time: order.createTime || "未知发单时间",
                        delay_ms: config.delayMs
                    };
                }
            } catch (error) {
                console.error('获取订单详情失败:', error);
            }
            return { area: '未知', order_type: '未知', amount: '未知' };
        }
        
        // 显示订单列表
        function displayOrders(orders) {
            const container = document.getElementById('ordersContainer');
            
            if (orders.length === 0) {
                container.innerHTML = '<div class="alert alert-info">暂无可用订单</div>';
                return;
            }
            
            let html = '<div class="row">';
            
            orders.forEach(order => {
                const isGrabbed = grabbedTaskIds.has(order.taskId);
                const badgeClass = isGrabbed ? 'bg-secondary' : 'bg-success';
                const badgeText = isGrabbed ? '已处理' : '可抢单';
                
                html += `
                    <div class="col-md-6">
                        <div class="card order-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <h5 class="card-title">${order.taskName || '未知订单'}</h5>
                                    <span class="badge ${badgeClass}">${badgeText}</span>
                                </div>
                                <h6 class="card-subtitle mb-2 text-muted">${order.categoryName || '未知区域'}</h6>
                                <p class="card-text">${order.description || '无描述'}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">订单ID: ${order.taskId}</small>
                                    <div>
                                        <button class="btn btn-sm btn-outline-primary me-1 view-order-btn" data-taskid="${order.taskId}">
                                            <i class="bi bi-eye"></i> 查看
                                        </button>
                                        ${!isGrabbed ? `
                                        <button class="btn btn-sm btn-success grab-order-btn" data-taskid="${order.taskId}">
                                            <i class="bi bi-lightning"></i> 抢单
                                        </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            // 绑定查看订单按钮事件
            document.querySelectorAll('.view-order-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const taskId = this.getAttribute('data-taskid');
                    showOrderDetail(taskId);
                });
            });
            
            // 绑定抢单按钮事件
            document.querySelectorAll('.grab-order-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const taskId = this.getAttribute('data-taskid');
                    const success = await takeOrder(taskId);
                    if (success) {
                        // 更新UI
                        grabbedTaskIds.add(taskId);
                        refreshOrders();
                        // 获取订单详情并添加到历史记录
                        const order = orders.find(o => o.taskId === taskId);
                        if (order) {
                            addToHistory(order);
                        }
                    }
                });
            });
        }
        
        // 显示订单详情
        async function showOrderDetail(taskId) {
            const modal = new bootstrap.Modal(document.getElementById('orderDetailModal'));
            const content = document.getElementById('orderDetailContent');
            
            content.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <p>正在加载订单详情...</p>
                </div>
            `;
            
            modal.show();
            
            try {
                const detail = await getOrderDetail(taskId);
                
                content.innerHTML = `
                    <div class="mb-3">
                        <h6>订单ID</h6>
                        <p>${detail.task_id || '未知'}</p>
                    </div>
                    <div class="mb-3">
                        <h6>区域</h6>
                        <p>${detail.area || '未知'}</p>
                    </div>
                    <div class="mb-3">
                        <h6>类型</h6>
                        <p>${detail.order_type || '未知'}</p>
                    </div>
                    <div class="mb-3">
                        <h6>发单单号</h6>
                        <p>${detail.ddh || '未知'}</p>
                    </div>
                    <div class="mb-3">
                        <h6>发单金额</h6>
                        <p>${detail.tmd || '未知'}</p>
                    </div>
                    <div class="mb-3">
                        <h6>到手金额</h6>
                        <p>${detail.amount || '未知'}</p>
                    </div>
                    <div class="mb-3">
                        <h6>发单时间</h6>
                        <p>${detail.send_time || '未知'}</p>
                    </div>
                `;
            } catch (error) {
                content.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> 加载订单详情失败: ${error.message}
                    </div>
                `;
            }
        }
        
        // 刷新订单列表
        async function refreshOrders() {
            if (!isRunning) {
                logMessage('手动刷新订单列表...', 'info');
            }
            
            try {
                const orders = await getAvailableOrders();
                displayOrders(orders);
                
                if (!isRunning) {
                    logMessage('订单列表已刷新', 'success');
                }
            } catch (error) {
                logMessage(`刷新订单列表失败: ${error.message}`, 'danger');
            }
        }
        
        // 保存配置
        function saveConfig() {
            saveConfigToMemory();
            
            try {
                localStorage.setItem('xltOrderGrabberConfig', JSON.stringify(config));
                logMessage('配置已保存', 'success');
            } catch (error) {
                logMessage(`保存配置失败: ${error.message}`, 'danger');
            }
        }
        
        // 保存配置到内存
        function saveConfigToMemory() {
            config.memberId = document.getElementById('memberId').value.trim();
            config.ids = document.getElementById('ids').value.trim();
            config.nickname = document.getElementById('nickname').value.trim();
            config.token = document.getElementById('token').value.trim();
            
            // 区域筛选
            const areaFilter = document.querySelector('input[name="areaFilter"]:checked').value;
            config.areaFilter = areaFilter === 'all' ? null : areaFilter;
            
            // 延迟
            config.delayMs = parseInt(document.getElementById('delay').value) || 300;
            
            // 关键词
            const keywordsInput = document.getElementById('keywordsInput').value.trim();
            config.keywords = keywordsInput ? keywordsInput.split(',').map(k => k.trim()).filter(k => k) : [];
            
            // 刷新间隔
            config.refreshMin = parseFloat(document.getElementById('refreshMin').value) || 0.3;
            config.refreshMax = parseFloat(document.getElementById('refreshMax').value) || 0.7;
        }
        
        // 加载上次配置
        function loadLastConfig() {
            try {
                const savedConfig = localStorage.getItem('xltOrderGrabberConfig');
                if (savedConfig) {
                    config = JSON.parse(savedConfig);
                    
                    // 更新表单
                    document.getElementById('memberId').value = config.memberId || '';
                    document.getElementById('ids').value = config.ids || '';
                    document.getElementById('nickname').value = config.nickname || '';
                    document.getElementById('token').value = config.token || '';
                    
                    // 区域筛选
                    const areaValue = config.areaFilter === null ? 'all' : config.areaFilter;
                    document.getElementById(`area${areaValue === 'all' ? 'All' : areaValue.toUpperCase()}`).checked = true;
                    
                    // 延迟
                    document.getElementById('delay').value = config.delayMs || 300;
                    
                    // 关键词
                    document.getElementById('keywordsInput').value = config.keywords ? config.keywords.join(', ') : '';
                    
                    // 刷新间隔
                    document.getElementById('refreshMin').value = config.refreshMin || 0.3;
                    document.getElementById('refreshMax').value = config.refreshMax || 0.7;
                    
                    logMessage('上次配置已加载', 'success');
                } else {
                    logMessage('没有找到上次的配置', 'info');
                }
            } catch (error) {
                logMessage(`加载配置失败: ${error.message}`, 'danger');
            }
        }
        
        // 验证配置
        function validateConfig() {
            saveConfigToMemory();
            
            if (!config.memberId || !config.ids || !config.nickname || !config.token) {
                logMessage('错误: 请填写完整的用户信息', 'danger');
                return false;
            }
            
            if (config.delayMs < 0 || config.delayMs > 1000) {
                logMessage('错误: 延迟时间必须在0-1000ms之间', 'danger');
                return false;
            }
            
            if (config.refreshMin < 0.1 || config.refreshMax > 10 || config.refreshMin > config.refreshMax) {
                logMessage('错误: 刷新间隔必须在0.1-10秒之间，且最小值不能大于最大值', 'danger');
                return false;
            }
            
            return true;
        }
        
        // 添加抢单记录
        function addToHistory(order) {
            const taskId = order.taskId;
            const now = new Date();
            const timeStr = now.toLocaleString();
            
            // 添加到历史记录表格
            const historyTable = document.getElementById('historyTableBody');
            
            // 如果表格是空的（只有提示行），则清空
            if (historyTable.rows.length === 1 && historyTable.rows[0].cells[0].colSpan === 6) {
                historyTable.innerHTML = '';
            }
            
            const row = historyTable.insertRow();
            row.innerHTML = `
                <td>${timeStr}</td>
                <td>${taskId}</td>
                <td>${order.categoryName || '未知'}</td>
                <td>${order.taskName || '未知'}</td>
                <td>${order.receivePrice || '未知'}</td>
                <td>${config.delayMs}ms</td>
            `;
            
            // 保存到本地存储
            const record = {
                time: timeStr,
                taskId: taskId,
                area: order.categoryName || '未知',
                type: order.taskName || '未知',
                amount: order.receivePrice || '未知',
                delay: config.delayMs
            };
            
            let history = JSON.parse(localStorage.getItem('xltOrderHistory') || []);
            history.unshift(record); // 添加到开头
            if (history.length > 100) {
                history = history.slice(0, 100); // 限制最多100条记录
            }
            localStorage.setItem('xltOrderHistory', JSON.stringify(history));
        }
        
        // 加载历史记录
        function loadHistory() {
            const historyTable = document.getElementById('historyTableBody');
            const history = JSON.parse(localStorage.getItem('xltOrderHistory') || '[]');
            
            if (history.length === 0) {
                historyTable.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">暂无抢单记录</td>
                    </tr>
                `;
                return;
            }
            
            historyTable.innerHTML = '';
            
            history.forEach(record => {
                const row = historyTable.insertRow();
                row.innerHTML = `
                    <td>${record.time}</td>
                    <td>${record.taskId}</td>
                    <td>${record.area}</td>
                    <td>${record.type}</td>
                    <td>${record.amount}</td>
                    <td>${record.delay}ms</td>
                `;
            });
        }
        
        // 清空历史记录
        function clearHistory() {
            if (confirm('确定要清空所有抢单记录吗？此操作不可撤销！')) {
                localStorage.removeItem('xltOrderHistory');
                document.getElementById('historyTableBody').innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">暂无抢单记录</td>
                    </tr>
                `;
                logMessage('抢单记录已清空', 'warning');
            }
        }
        
        // 导出历史记录
        function exportHistory() {
            const history = JSON.parse(localStorage.getItem('xltOrderHistory') || '[]');
            if (history.length === 0) {
                alert('没有可导出的抢单记录');
                return;
            }
            
            let csvContent = "时间,订单ID,区域,类型,金额,延迟(ms)\n";
            
            history.forEach(record => {
                csvContent += `"${record.time}","${record.taskId}","${record.area}","${record.type}","${record.amount}","${record.delay}"\n`;
            });
            
            downloadFile('小岛抢单记录.csv', csvContent);
        }
        
        // 记录日志
        function logMessage(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const now = new Date();
            const timeStr = now.toLocaleTimeString();
            
            let typeClass = 'text-muted';
            let prefix = '';
            
            switch (type) {
                case 'success':
                    typeClass = 'text-success';
                    prefix = '[✓] ';
                    break;
                case 'warning':
                    typeClass = 'text-warning';
                    prefix = '[!] ';
                    break;
                case 'danger':
                    typeClass = 'text-danger';
                    prefix = '[×] ';
                    break;
                case 'info':
                    typeClass = 'text-info';
                    prefix = '[i] ';
                    break;
            }
            
            const logEntry = document.createElement('div');
            logEntry.className = typeClass;
            logEntry.innerHTML = `<span class="text-muted">[${timeStr}]</span> ${prefix}${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // 保存到本地存储
            let logs = JSON.parse(localStorage.getItem('xltOrderLogs') || '[]');
            logs.push({ time: timeStr, message: message, type: type });
            if (logs.length > 200) {
                logs = logs.slice(logs.length - 200); // 限制最多200条日志
            }
            localStorage.setItem('xltOrderLogs', JSON.stringify(logs));
        }
        
        // 加载日志
        function loadLogs() {
            const logContainer = document.getElementById('logContainer');
            const logs = JSON.parse(localStorage.getItem('xltOrderLogs') || [];
            
            if (logs.length === 0) {
                logContainer.innerHTML = '<div class="text-muted">=== 小岛抢单工具日志 ===</div>';
                return;
            }
            
            logContainer.innerHTML = '<div class="text-muted">=== 小岛抢单工具日志 ===</div>';
            
            logs.forEach(log => {
                let typeClass = 'text-muted';
                let prefix = '';
                
                switch (log.type) {
                    case 'success':
                        typeClass = 'text-success';
                        prefix = '[✓] ';
                        break;
                    case 'warning':
                        typeClass = 'text-warning';
                        prefix = '[!] ';
                        break;
                    case 'danger':
                        typeClass = 'text-danger';
                        prefix = '[×] ';
                        break;
                    case 'info':
                        typeClass = 'text-info';
                        prefix = '[i] ';
                        break;
                }
                
                const logEntry = document.createElement('div');
                logEntry.className = typeClass;
                logEntry.innerHTML = `<span class="text-muted">[${log.time}]</span> ${prefix}${log.message}`;
                logContainer.appendChild(logEntry);
            });
            
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // 清空日志
        function clearLogs() {
            if (confirm('确定要清空所有日志吗？此操作不可撤销！')) {
                document.getElementById('logContainer').innerHTML = '<div class="text-muted">=== 小岛抢单工具日志 ===</div>';
                localStorage.removeItem('xltOrderLogs');
                logMessage('日志已清空', 'warning');
            }
        }
        
        // 导出日志
        function exportLogs() {
            const logs = JSON.parse(localStorage.getItem('xltOrderLogs') || '[]');
            if (logs.length === 0) {
                alert('没有可导出的日志');
                return;
            }
            
            let logContent = "时间,类型,消息\n";
            
            logs.forEach(log => {
                logContent += `"${log.time}","${log.type}","${log.message.replace(/"/g, '""')}"\n`;
            });
            
            downloadFile('小岛抢单日志.csv', logContent);
        }
        
        // 下载文件
        function downloadFile(filename, content) {
            const blob = new Blob(["\uFEFF" + content], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // 获取随机刷新间隔
        function getRandomRefreshInterval() {
            return parseFloat((Math.random() * (config.refreshMax - config.refreshMin) + config.refreshMin).toFixed(3));
        }
        
        // 获取区域筛选文本
        function getAreaFilterText(areaFilter) {
            if (areaFilter === null) return '全选';
            if (areaFilter === 'q') return 'Q区';
            if (areaFilter === 'v') return 'V区';
            return '未知';
        }
        
        // 睡眠函数
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // 初始化历史记录和日志
        loadHistory();
        loadLogs();
    </script>
</body>
</html>
