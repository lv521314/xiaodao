<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小岛自动抢单工具</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --success-color: #4cc9f0;
            --warning-color: #f8961e;
            --danger-color: #f94144;
            --dark-color: #1a1a2e;
            --light-color: #f8f9fa;
            --gray-color: #6c757d;
            --border-radius: 8px;
            --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .app-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            min-height: 100vh;
        }

        /* 侧边栏样式 */
        .sidebar {
            background-color: var(--dark-color);
            color: white;
            padding: 20px 0;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 10;
        }

        .logo {
            text-align: center;
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .logo p {
            font-size: 0.8rem;
            opacity: 0.7;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin: 5px 0;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: var(--transition);
            border-left: 3px solid transparent;
        }

        .nav-link:hover, .nav-link.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border-left-color: var(--primary-color);
        }

        .nav-link i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        /* 主内容区样式 */
        .main-content {
            padding: 20px;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .page-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--dark-color);
        }

        .user-profile {
            display: flex;
            align-items: center;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
        }

        /* 卡片样式 */
        .card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
            overflow: hidden;
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark-color);
        }

        .card-body {
            padding: 20px;
        }

        /* 表单元素样式 */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark-color);
        }

        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-family: inherit;
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
            outline: none;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        /* 按钮样式 */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            font-family: inherit;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
        }

        .btn i {
            margin-right: 8px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #3aa8d4;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background-color: #e07e0f;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #d62c2f;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--gray-color);
            color: var(--gray-color);
        }

        .btn-outline:hover {
            background-color: #f1f1f1;
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }

        /* 状态指示器 */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status-active {
            background-color: rgba(76, 201, 240, 0.2);
            color: var(--success-color);
        }

        .status-inactive {
            background-color: rgba(249, 65, 68, 0.2);
            color: var(--danger-color);
        }

        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .status-active .status-dot {
            background-color: var(--success-color);
        }

        .status-inactive .status-dot {
            background-color: var(--danger-color);
        }

        /* 关键词选择器 */
        .keyword-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .keyword-option {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            cursor: pointer;
            text-align: center;
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .keyword-option:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .keyword-option.selected {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* 日志区域 */
        .log-container {
            height: 300px;
            overflow-y: auto;
            background-color: #1e1e2e;
            color: #e0e0e0;
            border-radius: var(--border-radius);
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .log-entry {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .log-time {
            color: #6c757d;
            margin-right: 10px;
        }

        .log-success {
            color: #4cc9f0;
        }

        .log-info {
            color: #a5d8ff;
        }

        .log-warning {
            color: #f8961e;
        }

        .log-error {
            color: #f94144;
        }

        /* 统计卡片 */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            display: flex;
            align-items: center;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.5rem;
        }

        .stat-info {
            flex: 1;
        }

        .stat-title {
            font-size: 0.9rem;
            color: var(--gray-color);
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark-color);
        }

        /* 抢单记录表格 */
        .record-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .record-table th, .record-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .record-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        .record-table tr:hover {
            background-color: #f5f7fa;
        }

        /* 系统设置表单 */
        .settings-form {
            max-width: 600px;
        }

        /* 数据统计图表容器 */
        .chart-container {
            height: 400px;
            margin-top: 20px;
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .app-container {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                width: 100%;
                position: static;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .keyword-options {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
        }

        /* 隐藏内容 */
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- 侧边栏 -->
        <aside class="sidebar">
            <div class="logo">
                <h1>小岛抢单工具</h1>
                <p>自动高效 · 稳定可靠</p>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#" class="nav-link active" data-page="dashboard">
                        <i class="fas fa-bolt"></i>
                        <span>抢单控制台</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="records">
                        <i class="fas fa-history"></i>
                        <span>抢单记录</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="statistics">
                        <i class="fas fa-chart-line"></i>
                        <span>数据统计</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="settings">
                        <i class="fas fa-cog"></i>
                        <span>系统设置</span>
                    </a>
                </li>
            </ul>
        </aside>

        <!-- 主内容区 -->
        <main class="main-content">
            <!-- 抢单控制台页面 -->
            <div id="dashboard-page">
                <div class="header">
                    <h1 class="page-title">抢单控制台</h1>
                    <div class="user-profile">
                        <div class="user-avatar">A</div>
                        <span>管理员</span>
                    </div>
                </div>

                <!-- 统计卡片 -->
                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-icon" style="background-color: rgba(67, 97, 238, 0.1); color: var(--primary-color);">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-title">今日成功</div>
                            <div class="stat-value" id="todaySuccess">0</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background-color: rgba(76, 201, 240, 0.1); color: var(--success-color);">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-title">运行时长</div>
                            <div class="stat-value" id="runningTime">00:00:00</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background-color: rgba(248, 150, 30, 0.1); color: var(--warning-color);">
                            <i class="fas fa-bolt"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-title">抢单速度</div>
                            <div class="stat-value" id="grabSpeed">0ms</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background-color: rgba(249, 65, 68, 0.1); color: var(--danger-color);">
                            <i class="fas fa-times-circle"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-title">今日失败</div>
                            <div class="stat-value" id="todayFailed">0</div>
                        </div>
                    </div>
                </div>

                <!-- 抢单设置卡片 -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-sliders-h"></i> 抢单设置</h2>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">抢单延迟 (毫秒)</label>
                                <input type="number" class="form-control" id="delay" min="0" max="1000" value="300" placeholder="100-1000毫秒">
                            </div>
                            <div class="form-group">
                                <label class="form-label">区域筛选</label>
                                <select class="form-control" id="areaFilter">
                                    <option value="-1">全选</option>
                                    <option value="1">Q区</option>
                                    <option value="0">V区</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">关键词筛选</label>
                            <div class="keyword-options" id="keywordOptions">
                                <div class="keyword-option" data-key="1">开荒单</div>
                                <div class="keyword-option" data-key="2">护航加强单</div>
                                <div class="keyword-option" data-key="3">暑假快乐单</div>
                                <div class="keyword-option" data-key="4">实验基地专属</div>
                                <div class="keyword-option" data-key="5">烽火荣都专属</div>
                                <div class="keyword-option" data-key="6">至尊护航单</div>
                                <div class="keyword-option" data-key="7">狙击俱乐部单</div>
                                <div class="keyword-option" data-key="8">大神护航单</div>
                                <div class="keyword-option" data-key="9">赌超级无资箱</div>
                                <div class="keyword-option" data-key="a">保底BOSS单</div>
                                <div class="keyword-option" data-key="b">苏尔南钻石单</div>
                                <div class="keyword-option" data-key="c">鸡腿</div>
                                <div class="keyword-option" data-key="d">奶茶</div>
                                <div class="keyword-option" data-key="e">给打手加汉堡</div>
                                <div class="keyword-option" data-key="f">给打手加鸡腿</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">自定义关键词 (多个用逗号分隔)</label>
                            <input type="text" class="form-control" id="customKeywords" placeholder="例如: 高价值,紧急单">
                        </div>
                    </div>
                </div>

                <!-- 操作控制卡片 -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-play-circle"></i> 操作控制</h2>
                    </div>
                    <div class="card-body">
                        <div class="btn-group">
                            <button class="btn btn-primary" id="startBtn">
                                <i class="fas fa-play"></i> 开始抢单
                            </button>
                            <button class="btn btn-danger" id="stopBtn" disabled>
                                <i class="fas fa-stop"></i> 停止
                            </button>
                            <button class="btn btn-outline" id="loadConfigBtn">
                                <i class="fas fa-folder-open"></i> 加载配置
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 操作日志卡片 -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-terminal"></i> 操作日志</h2>
                        <button class="btn btn-outline" id="clearLogBtn">
                            <i class="fas fa-trash-alt"></i> 清空日志
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="log-container" id="logContainer">
                            <!-- 日志内容将通过JavaScript动态添加 -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- 抢单记录页面 -->
            <div id="records-page" class="hidden">
                <div class="header">
                    <h1 class="page-title">抢单记录</h1>
                    <div class="user-profile">
                        <div class="user-avatar">A</div>
                        <span>管理员</span>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-history"></i> 历史抢单记录</h2>
                        <button class="btn btn-outline" id="clearRecordsBtn">
                            <i class="fas fa-trash-alt"></i> 清空记录
                        </button>
                    </div>
                    <div class="card-body">
                        <table class="record-table">
                            <thead>
                                <tr>
                                    <th>时间</th>
                                    <th>订单ID</th>
                                    <th>区域</th>
                                    <th>类型</th>
                                    <th>金额</th>
                                </tr>
                            </thead>
                            <tbody id="recordsTableBody">
                                <!-- 记录将通过JavaScript动态添加 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 数据统计页面 -->
            <div id="statistics-page" class="hidden">
                <div class="header">
                    <h1 class="page-title">数据统计</h1>
                    <div class="user-profile">
                        <div class="user-avatar">A</div>
                        <span>管理员</span>
                    </div>
                </div>

                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-icon" style="background-color: rgba(67, 97, 238, 0.1); color: var(--primary-color);">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-title">总成功</div>
                            <div class="stat-value" id="totalSuccess">0</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background-color: rgba(249, 65, 68, 0.1); color: var(--danger-color);">
                            <i class="fas fa-times-circle"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-title">总失败</div>
                            <div class="stat-value" id="totalFailed">0</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background-color: rgba(76, 201, 240, 0.1); color: var(--success-color);">
                            <i class="fas fa-percentage"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-title">成功率</div>
                            <div class="stat-value" id="successRate">0%</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background-color: rgba(248, 150, 30, 0.1); color: var(--warning-color);">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-title">总收益</div>
                            <div class="stat-value" id="totalEarnings">¥0</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-chart-line"></i> 抢单趋势</h2>
                        <select class="form-control" id="statisticsPeriod" style="width: 150px;">
                            <option value="7">最近7天</option>
                            <option value="30">最近30天</option>
                            <option value="90">最近90天</option>
                        </select>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" id="trendChart">
                            <!-- 图表将通过JavaScript动态生成 -->
                            <p style="text-align: center; padding: 50px;">图表加载中...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 系统设置页面 -->
            <div id="settings-page" class="hidden">
                <div class="header">
                    <h1 class="page-title">系统设置</h1>
                    <div class="user-profile">
                        <div class="user-avatar">A</div>
                        <span>管理员</span>
                    </div>
                </div>

                <!-- 用户配置卡片 -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-user-cog"></i> 用户配置</h2>
                        <div class="status-indicator" id="configStatus">
                            <span class="status-dot"></span>
                            <span>未配置</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">memberId</label>
                                <input type="text" class="form-control" id="memberId" placeholder="请输入 memberId">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ids</label>
                                <input type="text" class="form-control" id="ids" placeholder="请输入 ids">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">nickname</label>
                                <input type="text" class="form-control" id="nickname" placeholder="请输入 nickname">
                            </div>
                            <div class="form-group">
                                <label class="form-label">token</label>
                                <input type="text" class="form-control" id="token" placeholder="请输入 token">
                            </div>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-primary" id="saveUserConfigBtn">
                                <i class="fas fa-save"></i> 保存用户配置
                            </button>
                            <button class="btn btn-outline" id="loadUserConfigBtn">
                                <i class="fas fa-folder-open"></i> 加载用户配置
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 系统参数设置卡片 -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-cog"></i> 系统参数设置</h2>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">自动启动</label>
                            <select class="form-control" id="autoStart">
                                <option value="0">禁用</option>
                                <option value="1">启用</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">日志保留天数</label>
                            <input type="number" class="form-control" id="logRetentionDays" min="1" max="365" value="7">
                        </div>
                        <div class="form-group">
                            <label class="form-label">数据备份路径</label>
                            <input type="text" class="form-control" id="backupPath" placeholder="请输入备份路径">
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-primary" id="saveSystemSettingsBtn">
                                <i class="fas fa-save"></i> 保存系统设置
                            </button>
                            <button class="btn btn-outline" id="restoreDefaultsBtn">
                                <i class="fas fa-undo"></i> 恢复默认
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 安全设置卡片 -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-shield-alt"></i> 安全设置</h2>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">自动锁定</label>
                            <select class="form-control" id="autoLock">
                                <option value="0">禁用</option>
                                <option value="5">5分钟不活动</option>
                                <option value="15">15分钟不活动</option>
                                <option value="30">30分钟不活动</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">数据加密</label>
                            <select class="form-control" id="dataEncryption">
                                <option value="0">禁用</option>
                                <option value="1">启用</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">密码保护</label>
                            <input type="password" class="form-control" id="appPassword" placeholder="设置应用密码">
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-primary" id="saveSecurityBtn">
                                <i class="fas fa-save"></i> 保存安全设置
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // 常量定义
        const BASE_URL = "https://paidan.xlt666.club/yxdl/api";
        const ORDER_LIST_URL = `${BASE_URL}/order/list?pageSize=10&pageNum=1&categoryId=0`;
        const TAKE_ORDER_URL = `${BASE_URL}/order/takeOrder`;
        
        // 关键词映射
        const KEYWORD_MAP = {
            "1": ["开荒单"], "2": ["护航加强单"], "3": ["暑假快乐单"], "4": ["实验基地专属"],
            "5": ["烽火荣都专属"], "6": ["至尊护航单"], "7": ["狙击俱乐部单"], "8": ["大神护航单"],
            "9": ["赌超级无资箱"], "a": ["保底BOSS单"], "b": ["苏尔南钻石单"], 
            "c": ["鸡腿"], "d": ["奶茶"], "e": ["给打手加汉堡"], "f": ["给打手加鸡腿"]
        };

        // 全局变量
        let isRunning = false;
        let grabbedTaskIds = new Set();
        let currentKeywords = [];
        let config = {
            member_id: "",
            ids: "",
            nickname: "",
            token: "",
            area_filter: null,
            keywords: [],
            delay_ms: 300
        };
        
        // 统计变量
        let successCount = 0;
        let failedCount = 0;
        let startTime = null;
        let timerInterval = null;

        // DOM 元素
        const logContainer = document.getElementById('logContainer');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const saveUserConfigBtn = document.getElementById('saveUserConfigBtn');
        const loadUserConfigBtn = document.getElementById('loadUserConfigBtn');
        const clearLogBtn = document.getElementById('clearLogBtn');
        const configStatus = document.getElementById('configStatus');
        const todaySuccessEl = document.getElementById('todaySuccess');
        const todayFailedEl = document.getElementById('todayFailed');
        const runningTimeEl = document.getElementById('runningTime');
        const grabSpeedEl = document.getElementById('grabSpeed');
        const clearRecordsBtn = document.getElementById('clearRecordsBtn');
        const recordsTableBody = document.getElementById('recordsTableBody');
        const totalSuccessEl = document.getElementById('totalSuccess');
        const totalFailedEl = document.getElementById('totalFailed');
        const successRateEl = document.getElementById('successRate');
        const totalEarningsEl = document.getElementById('totalEarnings');
        const saveSystemSettingsBtn = document.getElementById('saveSystemSettingsBtn');
        const restoreDefaultsBtn = document.getElementById('restoreDefaultsBtn');
        const saveSecurityBtn = document.getElementById('saveSecurityBtn');

        // 页面切换元素
        const dashboardPage = document.getElementById('dashboard-page');
        const recordsPage = document.getElementById('records-page');
        const statisticsPage = document.getElementById('statistics-page');
        const settingsPage = document.getElementById('settings-page');
        const navLinks = document.querySelectorAll('.nav-link');

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 加载保存的配置
            loadSavedConfig();
            
            // 关键词选择
            document.querySelectorAll('.keyword-option').forEach(option => {
                option.addEventListener('click', function() {
                    this.classList.toggle('selected');
                    updateKeywords();
                });
            });
            
            // 按钮事件
            startBtn.addEventListener('click', startGrabbing);
            stopBtn.addEventListener('click', stopGrabbing);
            saveUserConfigBtn.addEventListener('click', saveUserConfig);
            loadUserConfigBtn.addEventListener('click', loadSavedConfig);
            clearLogBtn.addEventListener('click', clearLogs);
            clearRecordsBtn.addEventListener('click', clearRecords);
            saveSystemSettingsBtn.addEventListener('click', saveSystemSettings);
            restoreDefaultsBtn.addEventListener('click', restoreDefaultSettings);
            saveSecurityBtn.addEventListener('click', saveSecuritySettings);
            
            // 表单变化事件
            document.getElementById('memberId').addEventListener('input', checkConfigStatus);
            document.getElementById('ids').addEventListener('input', checkConfigStatus);
            document.getElementById('nickname').addEventListener('input', checkConfigStatus);
            document.getElementById('token').addEventListener('input', checkConfigStatus);
            document.getElementById('customKeywords').addEventListener('input', updateKeywords);
            
            // 页面切换事件
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = this.getAttribute('data-page');
                    switchPage(page);
                });
            });
            
            // 初始化状态检查
            checkConfigStatus();
            
            // 加载记录数据
            loadRecords();
        });

        // 切换页面
        function switchPage(page) {
            // 隐藏所有页面
            dashboardPage.classList.add('hidden');
            recordsPage.classList.add('hidden');
            statisticsPage.classList.add('hidden');
            settingsPage.classList.add('hidden');
            
            // 显示目标页面
            document.getElementById(`${page}-page`).classList.remove('hidden');
            
            // 更新导航菜单活动状态
            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('data-page') === page) {
                    link.classList.add('active');
                }
            });
            
            // 如果是统计页面，更新统计数据
            if (page === 'statistics') {
                updateStatistics();
            }
        }

        // 保存用户配置
        function saveUserConfig() {
            try {
                config.member_id = document.getElementById('memberId').value.trim();
                config.ids = document.getElementById('ids').value.trim();
                config.nickname = document.getElementById('nickname').value.trim();
                config.token = document.getElementById('token').value.trim();
                
                localStorage.setItem('orderGrabberUserConfig', JSON.stringify(config));
                log('用户配置已保存', 'success');
                checkConfigStatus();
            } catch (error) {
                log(`保存用户配置失败: ${error.message}`, 'error');
            }
        }

        // 保存系统设置
        function saveSystemSettings() {
            try {
                const settings = {
                    autoStart: document.getElementById('autoStart').value,
                    logRetentionDays: document.getElementById('logRetentionDays').value,
                    backupPath: document.getElementById('backupPath').value
                };
                
                localStorage.setItem('orderGrabberSystemSettings', JSON.stringify(settings));
                log('系统设置已保存', 'success');
            } catch (error) {
                log(`保存系统设置失败: ${error.message}`, 'error');
            }
        }

        // 保存安全设置
        function saveSecuritySettings() {
            try {
                const securitySettings = {
                    autoLock: document.getElementById('autoLock').value,
                    dataEncryption: document.getElementById('dataEncryption').value,
                    appPassword: document.getElementById('appPassword').value
                };
                
                localStorage.setItem('orderGrabberSecurity', JSON.stringify(securitySettings));
                log('安全设置已保存', 'success');
            } catch (error) {
                log(`保存安全设置失败: ${error.message}`, 'error');
            }
        }

        // 恢复默认设置
        function restoreDefaultSettings() {
            if (confirm('确定要恢复默认设置吗？当前设置将被覆盖！')) {
                document.getElementById('autoStart').value = '0';
                document.getElementById('logRetentionDays').value = '7';
                document.getElementById('backupPath').value = '';
                document.getElementById('autoLock').value = '0';
                document.getElementById('dataEncryption').value = '0';
                document.getElementById('appPassword').value = '';
                log('已恢复默认设置', 'info');
            }
        }

        // 加载保存的配置
        function loadSavedConfig() {
            try {
                // 加载用户配置
                const savedUserConfig = localStorage.getItem('orderGrabberUserConfig');
                if (savedUserConfig) {
                    config = JSON.parse(savedUserConfig);
                    
                    document.getElementById('memberId').value = config.member_id || '';
                    document.getElementById('ids').value = config.ids || '';
                    document.getElementById('nickname').value = config.nickname || '';
                    document.getElementById('token').value = config.token || '';
                    
                    log('用户配置已加载', 'success');
                }
                
                // 加载系统设置
                const savedSystemSettings = localStorage.getItem('orderGrabberSystemSettings');
                if (savedSystemSettings) {
                    const settings = JSON.parse(savedSystemSettings);
                    
                    document.getElementById('autoStart').value = settings.autoStart || '0';
                    document.getElementById('logRetentionDays').value = settings.logRetentionDays || '7';
                    document.getElementById('backupPath').value = settings.backupPath || '';
                    
                    log('系统设置已加载', 'success');
                }
                
                // 加载安全设置
                const savedSecuritySettings = localStorage.getItem('orderGrabberSecurity');
                if (savedSecuritySettings) {
                    const security = JSON.parse(savedSecuritySettings);
                    
                    document.getElementById('autoLock').value = security.autoLock || '0';
                    document.getElementById('dataEncryption').value = security.dataEncryption || '0';
                    document.getElementById('appPassword').value = security.appPassword || '';
                    
                    log('安全设置已加载', 'success');
                }
                
                checkConfigStatus();
            } catch (error) {
                log(`加载配置失败: ${error.message}`, 'error');
            }
        }

        // 检查配置状态
        function checkConfigStatus() {
            const memberId = document.getElementById('memberId').value.trim();
            const ids = document.getElementById('ids').value.trim();
            const nickname = document.getElementById('nickname').value.trim();
            const token = document.getElementById('token').value.trim();
            
            if (memberId && ids && nickname && token) {
                configStatus.innerHTML = '<span class="status-dot"></span><span>已配置</span>';
                configStatus.className = 'status-indicator status-active';
            } else {
                configStatus.innerHTML = '<span class="status-dot"></span><span>未配置</span>';
                configStatus.className = 'status-indicator status-inactive';
            }
        }

        // 更新关键词列表
        function updateKeywords() {
            currentKeywords = [];
            
            // 添加选中的快捷关键词
            document.querySelectorAll('.keyword-option.selected').forEach(option => {
                const key = option.getAttribute('data-key');
                if (KEYWORD_MAP[key]) {
                    currentKeywords.push(...KEYWORD_MAP[key]);
                }
            });
            
            // 添加自定义关键词
            const customKeywords = document.getElementById('customKeywords').value;
            if (customKeywords) {
                customKeywords.split(',').forEach(kw => {
                    if (kw.trim()) {
                        currentKeywords.push(kw.trim());
                    }
                });
            }
            
            // 去重
            currentKeywords = [...new Set(currentKeywords)];
            
            log(`关键词已更新: ${currentKeywords.length ? currentKeywords.join(', ') : '无 (全选)'}`, 'info');
            checkConfigStatus();
        }

        // 开始抢单
        function startGrabbing() {
            if (isRunning) return;
            
            // 获取当前配置
            config.member_id = document.getElementById('memberId').value.trim();
            config.ids = document.getElementById('ids').value.trim();
            config.nickname = document.getElementById('nickname').value.trim();
            config.token = document.getElementById('token').value.trim();
            config.delay_ms = parseInt(document.getElementById('delay').value) || 300;
            
            const areaFilterValue = document.getElementById('areaFilter').value;
            config.area_filter = areaFilterValue === "-1" ? null : parseInt(areaFilterValue);
            
            updateKeywords();
            config.keywords = currentKeywords;
            
            // 验证必填项
            if (!config.token || !config.member_id || !config.ids || !config.nickname) {
                log('请填写所有必填的用户信息!', 'error');
                return;
            }
            
            isRunning = true;
            grabbedTaskIds.clear();
            
            // 重置统计
            successCount = 0;
            failedCount = 0;
            startTime = new Date();
            updateStats();
            
            // 启动计时器
            timerInterval = setInterval(updateStats, 1000);
            
            // 更新UI状态
            startBtn.disabled = true;
            stopBtn.disabled = false;
            
            log('自动抢单程序已启动', 'info');
            log(`区域筛选: ${config.area_filter === null ? '全选' : config.area_filter === 1 ? 'Q区' : 'V区'}`, 'info');
            log(`关键词: ${config.keywords.length ? config.keywords.join(', ') : '无 (全选)'}`, 'info');
            log(`抢单延迟: ${config.delay_ms}ms`, 'info');
            
            // 开始循环
            grabLoop();
        }

        // 停止抢单
        function stopGrabbing() {
            if (!isRunning) return;
            
            isRunning = false;
            
            // 停止计时器
            clearInterval(timerInterval);
            
            // 更新UI状态
            startBtn.disabled = false;
            stopBtn.disabled = true;
            
            log('自动抢单已停止', 'warning');
        }

        // 更新统计信息
        function updateStats() {
            if (startTime) {
                const now = new Date();
                const diff = Math.floor((now - startTime) / 1000);
                const hours = Math.floor(diff / 3600);
                const minutes = Math.floor((diff % 3600) / 60);
                const seconds = diff % 60;
                
                runningTimeEl.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            
            todaySuccessEl.textContent = successCount;
            todayFailedEl.textContent = failedCount;
            grabSpeedEl.textContent = `${config.delay_ms}ms`;
        }

        // 抢单主循环
        async function grabLoop() {
            while (isRunning) {
                try {
                    const orders = await getAvailableOrders();
                    
                    if (!orders.length) {
                        const waitTime = getRandomWaitTime();
                        log(`暂无符合条件的订单，${waitTime}秒后重试...`, 'info');
                        await sleep(waitTime * 1000);
                        continue;
                    }
                    
                    for (const order of orders) {
                        if (!isRunning) break;
                        
                        const taskId = order.taskId;
                        if (!taskId || grabbedTaskIds.has(taskId)) continue;
                        
                        log(`发现新订单 → ${order.taskName} (ID: ${taskId})`, 'info');
                        
                        const success = await takeOrder(taskId);
                        if (success) {
                            grabbedTaskIds.add(taskId);
                            successCount++;
                            updateStats();
                            log('已处理该订单，将跳过重复尝试', 'info');
                        } else {
                            failedCount++;
                            updateStats();
                        }
                    }
                    
                    if (isRunning) {
                        const waitTime = getRandomWaitTime();
                        log(`本轮检查完成，${waitTime}秒后继续...`, 'info');
                        await sleep(waitTime * 1000);
                    }
                } catch (error) {
                    log(`主循环异常: ${error.message}，5秒后恢复...`, 'error');
                    await sleep(5000);
                }
            }
        }

        // 获取可用订单
        async function getAvailableOrders() {
            try {
                const headers = { "token": config.token };
                const response = await fetch(ORDER_LIST_URL, { headers });
                
                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.code !== 200) {
                    throw new Error(`API错误: ${data.msg || '未知错误'}`);
                }
                
                const filteredOrders = [];
                
                for (const order of data.rows || []) {
                    // 检查订单状态
                    if (order.state !== 1) continue;
                    
                    // 区域筛选
                    let areaMatch = true;
                    if (config.area_filter !== null) {
                        const catName = (order.categoryName || "").toLowerCase();
                        areaMatch = (config.area_filter === 1 && catName.includes("q区")) || 
                                    (config.area_filter === 0 && catName.includes("v区"));
                    }
                    
                    // 关键词筛选
                    let keywordMatch = true;
                    if (config.keywords.length) {
                        const taskName = (order.taskName || "").toLowerCase();
                        const taskDesc = (order.description || "").toLowerCase();
                        
                        keywordMatch = config.keywords.some(kw => 
                            taskName.includes(kw.toLowerCase()) || 
                            taskDesc.includes(kw.toLowerCase())
                        );
                    }
                    
                    if (areaMatch && keywordMatch) {
                        filteredOrders.push(order);
                    }
                }
                
                return filteredOrders;
            } catch (error) {
                log(`获取订单失败: ${error.message}`, 'error');
                return [];
            }
        }

        // 抢单
        async function takeOrder(taskId) {
            try {
                log(`准备抢单 → 等待 ${config.delay_ms}ms 延迟...`, 'info');
                await sleep(config.delay_ms);
                
                const headers = {
                    "token": config.token,
                    "Content-Type": "application/json"
                };
                
                const data = {
                    "taskId": taskId,
                    "memberId": config.member_id,
                    "ids": [config.ids],
                    "nickname": config.nickname,
                    "avatar": "https://xiaolatiao.oss-cn-beijing.aliyuncs.com/uploadImg-test/wYp4xWmXfR.jpg"
                };
                
                const response = await fetch(TAKE_ORDER_URL, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.code === 200) {
                    const orderInfo = await getOrderDetail(taskId);
                    
                    log(`抢单成功！订单详情:`, 'success');
                    log(`  区域: ${orderInfo.area || '未知'}`, 'success');
                    log(`  类型: ${orderInfo.order_type || '未知'}`, 'success');
                    log(`  发单金额: ${orderInfo.tmd || '未知'}`, 'success');
                    log(`  到手金额: ${orderInfo.amount || '未知'}`, 'success');
                    log(`  发单单号: ${orderInfo.ddh || '未知'}`, 'success');
                    log(`  抢单时间: ${new Date().toLocaleString()}`, 'success');
                    
                    saveSuccessRecord(taskId, orderInfo);
                    return true;
                } else {
                    log(`抢单失败 → 原因: ${result.msg || '未知错误'}`, 'warning');
                    return false;
                }
            } catch (error) {
                log(`抢单出错 → ${error.message}`, 'error');
                return false;
            }
        }

        // 获取订单详情
        async function getOrderDetail(taskId) {
            try {
                const headers = { "token": config.token };
                const detailUrl = `${BASE_URL}/order/getInfo?taskId=${taskId}`;
                const response = await fetch(detailUrl, { headers });
                
                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.code === 200) {
                    const order = data.data || {};
                    return {
                        area: order.categoryName || "未知区域",
                        order_type: order.taskName || "未知类型",
                        ddh: order.orderNo || "未知单号",
                        tmd: order.receivePrice || "未知发单金额",
                        amount: order.outPrice || "未知到手金额",
                        send_time: order.createTime || "未知发单时间"
                    };
                } else {
                    throw new Error(data.msg || "获取详情失败");
                }
            } catch (error) {
                log(`获取详情失败 → ${error.message}`, 'error');
                return { area: '未知', order_type: '未知', amount: '未知' };
            }
        }

        // 保存成功记录
        function saveSuccessRecord(taskId, orderInfo) {
            try {
                const record = {
                    time: new Date().toISOString(),
                    task_id: taskId,
                    area: orderInfo.area,
                    order_type: orderInfo.order_type,
                    amount: orderInfo.amount,
                    delay_ms: config.delay_ms
                };
                
                let records = JSON.parse(localStorage.getItem('successRecords') || '[]');
                records.push(record);
                localStorage.setItem('successRecords', JSON.stringify(records));
                
                log('抢单记录已保存', 'success');
                
                // 更新记录显示
                loadRecords();
            } catch (error) {
                log(`保存记录失败: ${error.message}`, 'error');
            }
        }

        // 加载抢单记录
        function loadRecords() {
            try {
                const records = JSON.parse(localStorage.getItem('successRecords') || '[]');
                recordsTableBody.innerHTML = '';
                
                records.forEach(record => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${new Date(record.time).toLocaleString()}</td>
                        <td>${record.task_id}</td>
                        <td>${record.area}</td>
                        <td>${record.order_type}</td>
                        <td>${record.amount}</td>
                    `;
                    recordsTableBody.appendChild(row);
                });
                
                // 更新统计信息
                updateStatistics();
            } catch (error) {
                log(`加载记录失败: ${error.message}`, 'error');
            }
        }

        // 更新统计数据
        function updateStatistics() {
            try {
                const records = JSON.parse(localStorage.getItem('successRecords') || '[]');
                const total = records.length;
                const success = records.filter(r => r.amount !== '未知').length;
                const failed = total - success;
                const rate = total > 0 ? Math.round((success / total) * 100) : 0;
                
                // 计算总收益
                let earnings = 0;
                records.forEach(r => {
                    if (typeof r.amount === 'number') {
                        earnings += r.amount;
                    } else if (typeof r.amount === 'string' && r.amount.includes('¥')) {
                        const amount = parseFloat(r.amount.replace('¥', '').trim());
                        if (!isNaN(amount)) {
                            earnings += amount;
                        }
                    }
                });
                
                totalSuccessEl.textContent = success;
                totalFailedEl.textContent = failed;
                successRateEl.textContent = `${rate}%`;
                totalEarningsEl.textContent = `¥${earnings.toFixed(2)}`;
            } catch (error) {
                log(`更新统计失败: ${error.message}`, 'error');
            }
        }

        // 清空记录
        function clearRecords() {
            if (confirm('确定要清空所有抢单记录吗？此操作不可恢复！')) {
                localStorage.removeItem('successRecords');
                recordsTableBody.innerHTML = '';
                updateStatistics();
                log('抢单记录已清空', 'info');
            }
        }

        // 清空日志
        function clearLogs() {
            logContainer.innerHTML = '';
            log('日志已清空', 'info');
        }

        // 日志记录
        function log(message, type = 'info') {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            logEntry.innerHTML = `<span class="log-time">[${timestamp}]</span> ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // 辅助函数
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function getRandomWaitTime() {
            const min = 0.3;
            const max = 0.7;
            return (Math.random() * (max - min) + min).toFixed(3);
        }
    </script>
</body>
</html>
